# Spring Boot H2 Console CRUD Demo

Учебный проект на Java с использованием Spring Boot, H2 Database и Spring Data JPA. 
Проект демонстрирует работу с консольным интерфейсом (через `CommandLineRunner`) и подключением к внешнему серверу H2 через TCP.

## Цель проекта

Научиться:

- использовать Spring Boot и Spring Data JPA;
- подключаться к внешнему серверу H2;
- создавать CRUD-операции над сущностью `Person`;
- запускать приложение через консоль с помощью `CommandLineRunner`;
- управлять H2 сервером программно.

## Стек технологий

- Java 21  
- Spring Boot  
- Spring Data JPA  
- H2 Database (TCP server mode)  
- Maven  
- VS Code

## Основные функции

Приложение предоставляет консольный интерфейс для работы с базой данных людей со следующими возможностями:

### CRUD-операции
- **Добавление человека**  
  Ввод имени, фамилии и возраста с последующим сохранением в БД
- **Просмотр всех людей**  
  Вывод полного списка людей в системе
- **Поиск человека по ID**  
  Получение подробной информации о конкретном человеке
- **Обновление данных**  
  Изменение имени и фамилии существующей записи
- **Удаление человека**  
  Удаление записи по указанному ID

### Управление адресами
- **Добавление адреса**  
  Привязка адреса (город и улица) к существующей записи человека
- **Поиск по городу**  
  Получение списка людей, проживающих в указанном городе

### Расширенный поиск
- **Поиск по имени**  
  Поиск людей с полным совпадением имени
- **Поиск по возрастному диапазону**  
  Фильтрация людей по минимальному и максимальному возрасту

### Специальные операции
- **Годовое обновление возрастов**  
  Транзакционная операция, которая:
  - Увеличивает возраст всех людей на 1 год
  - Автоматически удаляет людей, достигших 100-летнего возраста
  - Гарантирует целостность данных (все или ничего)

### Особенности реализации
- Полноценная обработка ошибок (включая случай отсутствия человека)
- Консольный интерфейс с интуитивным меню
- Поддержка транзакций для критически важных операций
- Оптимизированные запросы к базе данных

Все функции доступны через интерактивное консольное меню после запуска приложения.

## Основные функциональные доработки

### 1. Обновление: update-person-age
- Добавлена колонка age в таблицу Person
- Реализовано сохранение и вывод возраста в `toString()`
- Добавлен метод `PersonNotFoundException` для обработки случаев, когда человек не найден
- Реализовано сохранение и вывод адреса через метод `addAddressToPerson(Long id, String city, String street)`

### 2. Обновление: feature/add-search-and-optimize-fetching
Добавлены поисковые методы:
- `findByName(String name)`
- `findByAgeBetween(int ageFrom, int ageTo)`
- `findByAddressCity(String city)`
- Оптимизирована загрузка данных (решение проблемы N+1) через метод `findPersonsWithAddresses()`

### 3. Обновление: feature/transactional-age-update
- Реализовано транзакционное обновление возраста:
  - Пакетное увеличение возраста всех людей на 1 (`increaseAgeForAllPersons()`)
  - Автоматическое удаление людей старше 100 лет (`deleteByAgeGreaterThanEqual()`)
  - Обе операции выполняются в одной транзакции (`@Transactional`)

### 4. Обновление: feature/change-name-and-optimistic-locking
- Добавлена функция изменения имени пользователя по ID (`changeName()`)
- Для предотвращения конфликтов при одновременном обновлении данных реализована **оптимистическая блокировка**:
  - В модель `Person` добавлено поле `@Version private Integer version;`
  - При попытке конкурентного обновления с устаревшей версией возникает исключение `OptimisticLockingFailureException`


## Как запустить

### 1. Запустить H2 TCP-сервер

```bash
# из IDE или через java
java -cp target/your-artifact-name.jar ru.home.training.java.cetrification.spring.db.H2Server
Если запускается из IDE — запусти класс H2Server.java с методом main.
```
2. Запустить основное приложение

# также из IDE или через jar
java -jar target/your-artifact-name.jar

Будет запущен интерактивный CLI-интерфейс с меню для управления записями Person.
3. (опционально) Подключиться к H2 через браузер

Если включена H2-консоль, перейдите в:

http://localhost:8080/h2-console

И укажите:
    JDBC URL: jdbc:h2:tcp://localhost:9092/~/test
    User: sa
    Password: (оставить пустым)

## Структура проекта
```
├── src/
│   └── main/
│       └── java/
│           └── ru.home.training.java.cetrification.spring/
│               ├── CommandLineApp.java              # CLI-интерфейс
│               ├── PersonService.java               # Сервис с логикой CRUD для Person
│               ├── db/
│               │   └── H2Server.java                # Запуск H2 TCP-сервера
│               ├── model/
│               │   ├── Person.java                  # Сущность Person
│               │   └── Address.java                 # Сущность Address
│               ├── repository/
│               │   ├── PersonRepository.java        # Spring Data репозиторий для Person
│               │   └── AddressRepository.java       # Spring Data репозиторий для Address
│               ├── resources/
│               │    └── application.properties
│				│
│               └── exseptions/
│                   └── PersonNotFoundException.java # Исключение, выбрасываемое при попытке найти несуществующего человека
│
├── pom.xml
├── README.md
└── .gitignore

```